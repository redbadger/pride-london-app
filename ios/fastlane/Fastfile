fastlane_version "2.82.0"

default_platform :ios

platform :ios do
  before_all do
    setup_circle_ci
  end

  desc "Runs all the tests"
  lane :test do
    scan(scheme: "PrideLondonApp")
  end

  desc "Signed build"
  lane :build do |options|
    match(
      type: options[:match_type], 
      app_identifier: options[:app_identifier],
      readonly: true
    )
    gym(
      clean: true,
      export_method: options[:export_method],
      configuration: options[:configuration],
      scheme: "PrideLondonApp"
    )
  end

  desc "Alpha build and deploy"
  lane :alpha do |options|
    build(
      match_type: "adhoc", 
      export_method: "ad-hoc",
      configuration: "AdhocAlpha",
      app_identifier: "org.prideinlondon.festival.alpha"
    )
    if options[:submit]
      deploy_hockey(
        commit_sha: options[:commit_sha],
        api_token: options[:api_token],
        app_id: options[:app_id],
        status: "2",
        notify: "0",
      )
    end
  end

  desc "Beta build and deploy"
  lane :beta do |options|
    ensure_git_branch(branch: "master")
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "PrideLondonApp.xcodeproj"
    )
    build(
      match_type: "appstore",
      export_method: "app-store",
      configuration: "Release",
      app_identifier: "org.prideinlondon.festival"
    )
    if options[:submit]
      deploy_testflight 
    end
    build(
      match_type: "adhoc", 
      export_method: "ad-hoc",
      configuration: "AdhocBeta",
      app_identifier: "org.prideinlondon.festival.beta"
    )
    if options[:submit]
      deploy_hockey(
        commit_sha: options[:commit_sha],
        api_token: options[:api_token],
        app_id: options[:app_id],
        status: "2",
        notify: "1",
      )
    end
  end

  desc "Upload to TestFlight and notify testers"
  lane :deploy_testflight do
    testflight(
      skip_submission: true,
      distribute_external: false,
      skip_waiting_for_build_processing: true
    )
  end

  desc "Upload to HockeyApp and notify testers"
  lane :deploy_hockey do |options|
    notes = sh("git log --format=%B -n 1 #{options[:commit_sha]}")
    hockey(
      api_token: options[:api_token],
      public_identifier: options[:app_id],
      notes: notes,
      status: options[:status],
      notify: options[:notify],
      commit_sha: options[:commit_sha]
    )
  end

  desc "Add devices"
  lane :devices do |options|
    new_devices = get_unprovisioned_devices_from_hockey(app_bundle_id:'org.prideinlondon.festival', api_token:options[:api_token])
    register_devices(devices: new_devices)
    match(
      type: "development",
      app_identifier: "org.prideinlondon.festival",
      force_for_new_devices: true
    )
    match(
      type: "adhoc",
      app_identifier: "org.prideinlondon.festival.alpha",
      force_for_new_devices: true
    )
    match(
      type: "adhoc",
      app_identifier: "org.prideinlondon.festival.beta",
      force_for_new_devices: true
    )
  end
end